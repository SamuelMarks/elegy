
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://poets-ai.github.io/elegy/guides/module-system/" rel="canonical"/>
<link href="../../images/favicon.png" rel="shortcut icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-5.5.3" name="generator"/>
<title>The Module System - Elegy</title>
<link href="../../assets/stylesheets/main.947af8d5.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
</head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#the-module-system">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header-nav md-grid">
<a aria-label="Elegy" class="md-header-nav__button md-logo" href="https://poets-ai.github.io/elegy" title="Elegy">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="M471.1 96C405 96 353.3 137.3 320 174.6 286.7 137.3 235 96 168.9 96 75.8 96 0 167.8 0 256s75.8 160 168.9 160c66.1 0 117.8-41.3 151.1-78.6 33.3 37.3 85 78.6 151.1 78.6 93.1 0 168.9-71.8 168.9-160S564.2 96 471.1 96zM168.9 320c-40.2 0-72.9-28.7-72.9-64s32.7-64 72.9-64c38.2 0 73.4 36.1 94 64-20.4 27.6-55.9 64-94 64zm302.2 0c-38.2 0-73.4-36.1-94-64 20.4-27.6 55.9-64 94-64 40.2 0 72.9 28.7 72.9 64s-32.7 64-72.9 64z"></path></svg>
</a>
<label class="md-header-nav__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header-nav__title" data-md-component="header-title">
<div class="md-header-nav__ellipsis">
<span class="md-header-nav__topic md-ellipsis">
            Elegy
          </span>
<span class="md-header-nav__topic md-ellipsis">
            
              The Module System
            
          </span>
</div>
</div>
<label class="md-header-nav__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" data-md-component="search-reset" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header-nav__source">
<a class="md-source" href="https://github.com/poets-ai/elegy/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" fill-rule="evenodd"></path></svg>
</div>
<div class="md-source__repository">
    poets-ai/elegy
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Elegy" class="md-nav__button md-logo" href="https://poets-ai.github.io/elegy" title="Elegy">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="M471.1 96C405 96 353.3 137.3 320 174.6 286.7 137.3 235 96 168.9 96 75.8 96 0 167.8 0 256s75.8 160 168.9 160c66.1 0 117.8-41.3 151.1-78.6 33.3 37.3 85 78.6 151.1 78.6 93.1 0 168.9-71.8 168.9-160S564.2 96 471.1 96zM168.9 320c-40.2 0-72.9-28.7-72.9-64s32.7-64 72.9-64c38.2 0 73.4 36.1 94 64-20.4 27.6-55.9 64-94 64zm302.2 0c-38.2 0-73.4-36.1-94-64 20.4-27.6 55.9-64 94-64 40.2 0 72.9 28.7 72.9 64s-32.7 64-72.9 64z"></path></svg>
</a>
    Elegy
  </label>
<div class="md-nav__source">
<a class="md-source" href="https://github.com/poets-ai/elegy/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" fill-rule="evenodd"></path></svg>
</div>
<div class="md-source__repository">
    poets-ai/elegy
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../.." title="Introduction">
      Introduction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../getting-started/" title="Getting Started">
      Getting Started
    </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="nav-3" id="nav-3" type="checkbox"/>
<label class="md-nav__link" for="nav-3">
      Guides
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="Guides" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-3">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        Guides
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
        The Module System
        <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"></path></svg>
</span>
</label>
<a class="md-nav__link md-nav__link--active" href="./" title="The Module System">
      The Module System
    </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#traditional-object-oriented-style">
    Traditional Object Oriented Style
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#elegy-hooks">
    Elegy Hooks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#module-hooks-functional-style">
    Module Hooks: Functional Style
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#init-apply">
    init &amp; apply
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hooks-preserve-references">
    Hooks Preserve References
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#managing-state">
    Managing State
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#low-level-training-loop">
    Low-level Training Loop
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-equivalent">
    High Level Equivalent
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../modules-losses-metrics/" title="Modules, Losses, and Metrics">
      Modules, Losses, and Metrics
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../contributing/" title="Contibuting">
      Contibuting
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" id="nav-4" type="checkbox"/>
<label class="md-nav__link" for="nav-4">
      API Reference
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="API Reference" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="nav-4">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        API Reference
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/Loss/" title="Loss">
      Loss
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/Metric/" title="Metric">
      Metric
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/Model/" title="Model">
      Model
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/Module/" title="Module">
      Module
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/PRNGSequence/" title="PRNGSequence">
      PRNGSequence
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/add_loss/" title="add_loss">
      add_loss
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/add_metric/" title="add_metric">
      add_metric
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/add_summary/" title="add_summary">
      add_summary
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-9" id="nav-4-9" type="checkbox"/>
<label class="md-nav__link" for="nav-4-9">
      callbacks
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="callbacks" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-9">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        callbacks
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/CSVLogger/" title="CSVLogger">
      CSVLogger
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/Callback/" title="Callback">
      Callback
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/CallbackList/" title="CallbackList">
      CallbackList
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/EarlyStopping/" title="EarlyStopping">
      EarlyStopping
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/History/" title="History">
      History
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/LambdaCallback/" title="LambdaCallback">
      LambdaCallback
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/ModelCheckpoint/" title="ModelCheckpoint">
      ModelCheckpoint
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/RemoteMonitor/" title="RemoteMonitor">
      RemoteMonitor
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/TensorBoard/" title="TensorBoard">
      TensorBoard
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/callbacks/TerminateOnNaN/" title="TerminateOnNaN">
      TerminateOnNaN
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/get_parameter/" title="get_parameter">
      get_parameter
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/get_state/" title="get_state">
      get_state
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-12" id="nav-4-12" type="checkbox"/>
<label class="md-nav__link" for="nav-4-12">
      hooks
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="hooks" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-12">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        hooks
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/hooks/add_loss/" title="add_loss">
      add_loss
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/hooks/add_metric/" title="add_metric">
      add_metric
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/hooks/add_summary/" title="add_summary">
      add_summary
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/hooks/get_parameter/" title="get_parameter">
      get_parameter
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/hooks/get_state/" title="get_state">
      get_state
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/hooks/next_rng_key/" title="next_rng_key">
      next_rng_key
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/hooks/set_state/" title="set_state">
      set_state
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-13" id="nav-4-13" type="checkbox"/>
<label class="md-nav__link" for="nav-4-13">
      initializers
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="initializers" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-13">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        initializers
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/initializers/Constant/" title="Constant">
      Constant
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/initializers/Orthogonal/" title="Orthogonal">
      Orthogonal
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/initializers/RandomNormal/" title="RandomNormal">
      RandomNormal
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/initializers/RandomUniform/" title="RandomUniform">
      RandomUniform
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/initializers/TruncatedNormal/" title="TruncatedNormal">
      TruncatedNormal
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/initializers/UniformScaling/" title="UniformScaling">
      UniformScaling
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/initializers/VarianceScaling/" title="VarianceScaling">
      VarianceScaling
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-14" id="nav-4-14" type="checkbox"/>
<label class="md-nav__link" for="nav-4-14">
      losses
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="losses" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-14">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        losses
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/BinaryCrossentropy/" title="BinaryCrossentropy">
      BinaryCrossentropy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/CategoricalCrossentropy/" title="CategoricalCrossentropy">
      CategoricalCrossentropy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/Loss/" title="Loss">
      Loss
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/MeanAbsoluteError/" title="MeanAbsoluteError">
      MeanAbsoluteError
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/MeanAbsolutePercentageError/" title="MeanAbsolutePercentageError">
      MeanAbsolutePercentageError
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/MeanSquaredError/" title="MeanSquaredError">
      MeanSquaredError
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/Reduction/" title="Reduction">
      Reduction
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/SparseCategoricalCrossentropy/" title="SparseCategoricalCrossentropy">
      SparseCategoricalCrossentropy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/binary_crossentropy/" title="binary_crossentropy">
      binary_crossentropy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/mean_absolute_error/" title="mean_absolute_error">
      mean_absolute_error
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/mean_percentage_absolute_error/" title="mean_percentage_absolute_error">
      mean_percentage_absolute_error
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/mean_squared_error/" title="mean_squared_error">
      mean_squared_error
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/losses/sparse_categorical_crossentropy/" title="sparse_categorical_crossentropy">
      sparse_categorical_crossentropy
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-15" id="nav-4-15" type="checkbox"/>
<label class="md-nav__link" for="nav-4-15">
      metrics
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="metrics" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-15">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        metrics
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/Accuracy/" title="Accuracy">
      Accuracy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/BinaryCrossentropy/" title="BinaryCrossentropy">
      BinaryCrossentropy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/CategoricalAccuracy/" title="CategoricalAccuracy">
      CategoricalAccuracy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/Mean/" title="Mean">
      Mean
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/MeanAbsoluteError/" title="MeanAbsoluteError">
      MeanAbsoluteError
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/MeanSquaredError/" title="MeanSquaredError">
      MeanSquaredError
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/Metric/" title="Metric">
      Metric
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/Reduce/" title="Reduce">
      Reduce
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/SparseCategoricalAccuracy/" title="SparseCategoricalAccuracy">
      SparseCategoricalAccuracy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/Sum/" title="Sum">
      Sum
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/accuracy/" title="accuracy">
      accuracy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/binary_crossentropy/" title="binary_crossentropy">
      binary_crossentropy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/categorical_accuracy/" title="categorical_accuracy">
      categorical_accuracy
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/mean_absolute_error/" title="mean_absolute_error">
      mean_absolute_error
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/mean_squared_error/" title="mean_squared_error">
      mean_squared_error
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/reduce/" title="reduce">
      reduce
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/metrics/sparse_categorical_accuracy/" title="sparse_categorical_accuracy">
      sparse_categorical_accuracy
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-16" id="nav-4-16" type="checkbox"/>
<label class="md-nav__link" for="nav-4-16">
      model
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="model" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-16">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        model
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/model/Model/" title="Model">
      Model
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/model/load/" title="load">
      load
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-17" id="nav-4-17" type="checkbox"/>
<label class="md-nav__link" for="nav-4-17">
      module
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="module" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-17">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        module
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/module/Module/" title="Module">
      Module
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/module/to_module/" title="to_module">
      to_module
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/next_rng_key/" title="next_rng_key">
      next_rng_key
    </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-19" id="nav-4-19" type="checkbox"/>
<label class="md-nav__link" for="nav-4-19">
      nn
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="nn" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-19">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        nn
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/BatchNormalization/" title="BatchNormalization">
      BatchNormalization
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Conv1D/" title="Conv1D">
      Conv1D
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Conv2D/" title="Conv2D">
      Conv2D
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Conv3D/" title="Conv3D">
      Conv3D
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/ConvND/" title="ConvND">
      ConvND
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Dropout/" title="Dropout">
      Dropout
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Flatten/" title="Flatten">
      Flatten
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/InstanceNormalization/" title="InstanceNormalization">
      InstanceNormalization
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/LayerNormalization/" title="LayerNormalization">
      LayerNormalization
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Linear/" title="Linear">
      Linear
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Reshape/" title="Reshape">
      Reshape
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/Sequential/" title="Sequential">
      Sequential
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/nn/sequential/" title="sequential">
      sequential
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-20" id="nav-4-20" type="checkbox"/>
<label class="md-nav__link" for="nav-4-20">
      regularizers
      <span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"></path></svg>
</span>
</label>
<nav aria-label="regularizers" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="nav-4-20">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
        regularizers
      </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/regularizers/GlobalL1/" title="GlobalL1">
      GlobalL1
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/regularizers/GlobalL1L2/" title="GlobalL1L2">
      GlobalL1L2
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/regularizers/GlobalL2/" title="GlobalL2">
      GlobalL2
    </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/set_state/" title="set_state">
      set_state
    </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../api/to_module/" title="to_module">
      to_module
    </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#traditional-object-oriented-style">
    Traditional Object Oriented Style
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#elegy-hooks">
    Elegy Hooks
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#module-hooks-functional-style">
    Module Hooks: Functional Style
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#init-apply">
    init &amp; apply
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#hooks-preserve-references">
    Hooks Preserve References
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#managing-state">
    Managing State
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#low-level-training-loop">
    Low-level Training Loop
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#high-level-equivalent">
    High Level Equivalent
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/poets-ai/elegy/edit/master/docs/guides/module-system.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="the-module-system">The Module System</h1>
<p>This is a guide to Elegy's underlying Module System. It will help get a better understanding of how
Elegy interacts with Jax at the lower level, certain details about the hooks system and how it
differs from other Deep Learning frameworks.</p>
<h3 id="traditional-object-oriented-style">Traditional Object Oriented Style</h3>
<p>We will begin by exploring other frameworks define Modules / Layers. It is very common to use
Object Oriented architectures as backbones of Module systems as it helps frameworks keep
track of the parameters and states each module might require. Here we will create a some
very basic <code>Linear</code> and <code>MLP</code> modules which will seem very familiar:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Linear</span><span class="p">(</span><span class="n">elegy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_in</span><span class="p">,</span> <span class="n">n_out</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span>
            <span class="s2">"w"</span><span class="p">,</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_out</span><span class="p">],</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">elegy</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomUniform</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="p">[</span><span class="n">n_out</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">elegy</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomUniform</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span>

<span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">elegy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_in</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="n">n_in</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear3</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear3</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<p>Here we just defined a simple linear layer and used it inside a <code>MLP</code> with 3 layers. Pytorch and Keras 
users should feel very familiar with this type of code: we define parameters 
or other submodules in the <code>__init__</code> method, and use them during the <code>call</code> (forward) method.
Keras users users might complain that if we do things this way we loose the ability to do 
shape inference, but don't worry, we will fix that latter.</p>
<p>Fow now it is important to notice that here we use our first hook: <code>get_parameter</code>.</p>
<h3 id="elegy-hooks">Elegy Hooks</h3>
<p>Hooks are a way in which we can manage state while preserving functional purity (in the end).
Elegy's hook system is ported and expanded from Haiku, but hook-based functional architectures in
other areas like web development have proven valuable, React Hooks being a recent notable success.</p>
<p>In Elegy we have the following list of hooks:</p>
<table>
<thead>
<tr>
<th>Hook</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>get_parameter</code></td>
<td>Gives us access to a trainable parameter.</td>
</tr>
<tr>
<td><code>get_state</code></td>
<td>Gives us access to some state. This is used in layers like <code>BatchNormalization</code> and in most of the metrics.</td>
</tr>
<tr>
<td><code>set_state</code></td>
<td>Lets us update a state. When used in conjunction with <code>get_state</code> it lets use express an iterative computation.</td>
</tr>
<tr>
<td><code>next_rng_key</code></td>
<td>Gives us access to a unique <code>PRNGKey</code> we can pass to functions like <code>jax.random.uniform</code> and friends.</td>
</tr>
<tr>
<td><code>is_training</code></td>
<td>Tells use whether training is currently happening or not.</td>
</tr>
<tr>
<td><code>add_loss</code></td>
<td>Lets us declare a loss in some intermediate layer.</td>
</tr>
<tr>
<td><code>add_metric</code></td>
<td>Lets us declare a metric in some intermediate layer.</td>
</tr>
<tr>
<td><code>add_summary</code></td>
<td>Lets us declare a summary in some intermediate layer.</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use existing <code>Module</code>s you might not need to worry much about these hooks, but keep them in mind
if you are developing your own custom modules.</p>
</div>
<h3 id="module-hooks-functional-style">Module Hooks: Functional Style</h3>
<p>In the initial example we used hooks in a very shy manner to replicate the behavior of
of other frameworks, now we will go beyond. The first thing we need to know is that:</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p><strong>Modules are hooks</strong></p>
</div>
<p>This means that module <em>instantiation</em> taps into the hook system, and that hooks are
aware of the module in which they are executing in. In practice this will mean that we
will be able to move a lot of the code defined on the <code>__init__</code> method to
the <code>call</code> method:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Linear</span><span class="p">(</span><span class="n">elegy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_out</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_out</span> <span class="o">=</span> <span class="n">n_out</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span>
            <span class="s2">"w"</span><span class="p">,</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_out</span><span class="p">],</span>
            <span class="n">initializer</span><span class="o">=</span><span class="n">elegy</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomUniform</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_out</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>

<span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">elegy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<p>What happened here? Lets decompose it into two parts. First we moved the <code>get_parameter</code> definitions
on the <code>Linear</code> module to the <code>call</code> method:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">Linear</span><span class="p">(</span><span class="n">elegy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_out</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_out</span> <span class="o">=</span> <span class="n">n_out</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="hll">        <span class="n">w</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span>
</span><span class="hll">            <span class="s2">"w"</span><span class="p">,</span>
</span><span class="hll">            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_out</span><span class="p">],</span>
</span><span class="hll">            <span class="n">initializer</span><span class="o">=</span><span class="n">elegy</span><span class="o">.</span><span class="n">initializers</span><span class="o">.</span><span class="n">RandomUniform</span><span class="p">(),</span>
</span><span class="hll">        <span class="p">)</span>
</span>        <span class="n">b</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s2">"b"</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_out</span><span class="p">],</span> <span class="n">initializer</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>
</code></pre></div>
<p>As you see this allows us to do shape inference since we have access
to the inputs when defining our parameter's shape. Second, we also moved the instantiation
of the <code>Linear</code> modules in <code>MLP</code> from <code>__init__</code> to <code>call</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">MLP</span><span class="p">(</span><span class="n">elegy</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="hll">        <span class="n">x</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="hll">        <span class="n">x</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="hll">        <span class="n">x</span> <span class="o">=</span> <span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
</span>        <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<p>Here we are using Modules as hooks. While it may <em>appear</em> as if we are instantiating
3 new <code>Linear</code> modules on every <code>call</code>, Elegy is actually caching them behind the scenes
with the help of Python metaclasses. There is one important rule you have to follow:</p>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>You must use hooks <strong>unconditionally</strong></p>
</div>
<p>This moto comes from React and it means that the module always has to call the same amount
of hooks, and for module hooks specifically they must be called in the same order. For example the following code is invalid:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<p>Here <code>Linear</code> and <code>Conv2D</code> are dangerously swapped based on some condition. If you want to
do this you can just clare them unconditionally and use them inside the condition:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">conv2d</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">conv2d</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div>
<h3 id="init-apply">init &amp; apply</h3>
<p>This functional freedom inside Modules comes at a cost outside of them
which is that you cannot call the top-level module directly. If you try to run this code:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">mlp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
<p>You will get the following error:</p>
<blockquote>
<p>ValueError: Cannot execute <code>call</code> outside of a <code>elegy.context</code></p>
</blockquote>
<p>In practice this means that you will have to use the methods <code>init</code> and <code>apply</code>
to manage your modules:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">rngs</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">PRNGSequence</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">mlp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
<p>A lot is happening here so lets unpack it. First we used <code>Module.init(...)</code> and passed
it an <code>rng</code> key. </p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">rngs</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">PRNGSequence</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="hll"><span class="n">mlp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
<p>This key is necessary because <code>Linear</code> uses <code>elegy.initializers.RandomUniform</code>
which requires a random key to initialize our weights. <code>init</code> takes in some parameters and
returns callable which expect the same arguments as <code>call</code> and will initialize our module. 
Next we use <code>Module.apply(...)</code> very similarly but this time we get back some predictions and
a context:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">rngs</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">PRNGSequence</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">mlp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="hll"><span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<p>Right now we won't use this context object but its useful to know that this object will
collect most of the information given by hooks like <code>get_parameter</code>, <code>get_state</code>, <code>add_loss</code>,
<code>add_metric</code>, etc.</p>
<h3 id="hooks-preserve-references">Hooks Preserve References</h3>
<p>In our <code>MLP</code> class we where able to create the <code>Linear</code> modules at their call site, this
simplified our code a lot but we've seem to lost the reference to these modules. Having 
reference to other modules is critical for being able to e.g. easily compose modules that might be
trained separately like in transfer learning, or being able to easily decompose / extract a sub-module
and use it separately like when using the decoder of a VAE by itself to generate new samples.</p>
<p>Because of this, Elegy actually assigns all submodules, parameters, and states as properties
of the module:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">rngs</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">PRNGSequence</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">mlp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="hll"><span class="n">linear</span><span class="p">,</span> <span class="n">linear_1</span><span class="p">,</span> <span class="n">linear_2</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">mlp</span><span class="o">.</span><span class="n">linear_1</span><span class="p">,</span> <span class="n">mlp</span><span class="o">.</span><span class="n">linear_2</span>
</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
<span class="hll"><span class="k">assert</span> <span class="n">linear</span> <span class="ow">is</span> <span class="n">mlp</span><span class="o">.</span><span class="n">linear</span> <span class="ow">and</span> <span class="n">linear_1</span> <span class="ow">is</span> <span class="n">mlp</span><span class="o">.</span><span class="n">linear_1</span> <span class="ow">and</span> <span class="n">linear_2</span> <span class="ow">is</span> <span class="n">mlp</span><span class="o">.</span><span class="n">linear_2</span>
</span></code></pre></div>
<p>As you see we were able to access all the linear layer references. More over, we verified that
these reference don't change during execution. Each submodule gets assigned to a 
a unique field name based on its class name and order of creation. You can
customize this name by using the <code>name</code> argument available in the <code>Module</code>'s constructor.</p>
<h3 id="managing-state">Managing State</h3>
<p>A big theme in Jax is that is that state and computation are separate, this is a requirement
because in order for combinators like <code>jax.grad</code> and <code>jax.jit</code> to work you need pure functions,
and pure functions usually require you to extract state and turn it into an input. To achieve this
we will use additional feature from <code>init</code> and <code>apply</code> that where created for this purpose:</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">rngs</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">PRNGSequence</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="hll"><span class="n">parameters</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
</span><span class="hll"><span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>
</span></code></pre></div>
<p>The first thing is that <code>init</code> actually returns the initial <code>parameters</code> and <code>states</code>,
these are dictionaries whose structure has a 1-to-1 correspondence with the structure of 
the network. The second is that <code>apply</code> accepts these parameters and states as arguments. 
This is a step in the right direction since now our state is externalized.</p>
<h3 id="low-level-training-loop">Low-level Training Loop</h3>
<p>Using the previous plus regular jax we can actually implement a basic training loop
for our module. We will go ahead and show the solution and explain it afterwards:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>


<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">gradients</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">)(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_multimap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">p</span> <span class="o">-</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">g</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parameters</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">parameters</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">mlp</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</code></pre></div>
<p>Here we created the functions <code>loss</code> and <code>update</code>, plus a minimal training loop.
In order to for us to be able to calculate gradients of the loss with respect
to the parameters we need for <code>loss</code> to take them an argument along with the 
inputs <code>x</code> and labels <code>y</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="hll"><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span>    <span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>


<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="hll">    <span class="n">gradients</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">)(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span>    <span class="n">parameters</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_multimap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">p</span> <span class="o">-</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">g</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">parameters</span>
</code></pre></div>
<p>Note that <code>grad</code> by default calculate the gradient of the function
with respect to the first argument, which in this case is a structure
with all the parameters. Because we are using <code>jax.jit</code> we also require
that any desired changes propagated as outputs:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">y_pred</span><span class="p">,</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">))</span>


<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="hll"><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span>    <span class="n">gradients</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">loss</span><span class="p">)(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_multimap</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="n">p</span> <span class="o">-</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">g</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">gradients</span>
    <span class="p">)</span>
<span class="hll">    <span class="k">return</span> <span class="n">parameters</span>
</span></code></pre></div>
<p>The strategy is to iteratively update the parameters of the
network by feeding them as inputs and reassigning them after
the output.</p>
<div class="codehilite"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">()</span>
<span class="n">parameters</span><span class="p">,</span> <span class="n">states</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">rng</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">))(</span><span class="n">x</span><span class="p">)</span>

<span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
<span class="hll">    <span class="n">parameters</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="n">rngs</span><span class="p">),</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span>
<span class="hll"><span class="n">mlp</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
</span></code></pre></div>
<p>Note that once we are done training we can actually insert these learned parameters
back into our module objects by using <code>set_parameters</code>.</p>
<h3 id="high-level-equivalent">High Level Equivalent</h3>
<p>If all this seems a bit too manual for you don't worry, you can can easily express 
all the previous in a few lines of code using an <code>elegy.Model</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">elegy</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
    <span class="n">module</span><span class="o">=</span><span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
            <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
            <span class="n">jax</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">,</span>
            <span class="n">elegy</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">),</span>
    <span class="n">loss</span><span class="o">=</span><span class="n">elegy</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">MeanSquaredError</span><span class="p">(),</span>
<span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">epochs</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav aria-label="Footer" class="md-footer-nav__inner md-grid">
<a class="md-footer-nav__link md-footer-nav__link--prev" href="../../getting-started/" rel="prev" title="Getting Started">
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Previous
                </span>
                Getting Started
              </div>
</div>
</a>
<a class="md-footer-nav__link md-footer-nav__link--next" href="../modules-losses-metrics/" rel="next" title="Modules, Losses, and Metrics">
<div class="md-footer-nav__title">
<div class="md-ellipsis">
<span class="md-footer-nav__direction">
                  Next
                </span>
                Modules, Losses, and Metrics
              </div>
</div>
<div class="md-footer-nav__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/cgarciae" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" fill-rule="evenodd"></path></svg>
</a>
<a class="md-footer-social__link" href="https://github.com/charlielito" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z" fill-rule="evenodd"></path></svg>
</a>
<a class="md-footer-social__link" href="https://twitter.com/cgarciae88" rel="noopener" target="_blank" title="twitter.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://www.linkedin.com/in/cgarciae" rel="noopener" target="_blank" title="www.linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://www.linkedin.com/in/calvarez92" rel="noopener" target="_blank" title="www.linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<script src="../../assets/javascripts/vendor.c3dc8c49.min.js"></script>
<script src="../../assets/javascripts/bundle.f9edbbd5.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
<script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.8e2cddea.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>